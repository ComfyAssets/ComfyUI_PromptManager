<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PromptManager - Gallery</title>
    <link rel="stylesheet" href="/prompt_manager/css/style.css" />
    <link rel="stylesheet" href="/prompt_manager/css/blue-theme-update.css" />
    <link rel="stylesheet" href="/prompt_manager/css/components.css" />
    <link rel="stylesheet" href="/prompt_manager/css/gallery.css" />
    <link rel="stylesheet" href="/prompt_manager/css/notifications.css" />
    <link rel="stylesheet" href="/prompt_manager/css/migration.css" />
    <link rel="stylesheet" href="/prompt_manager/css/scan-modal.css" />
    <link rel="stylesheet" href="/prompt_manager/css/metadata.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- ViewerJS CSS -->
    <link rel="stylesheet" href="/prompt_manager/lib/viewerjs/dist/viewer.min.css" />

</head>
  <body>
    <div class="app-container">
      <!-- Sidebar -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div id="brand-badge" class="brand-badge">PM</div>
          <div>
            <div class="sidebar-header-title">PromptManager</div>
            <div class="sidebar-header-subtitle">
              Professional Suite
            </div>
          </div>
        </div>

                                                <nav class="nav-menu">
          <a href="/prompt_manager/" class="nav-item">
            <i class="fa-solid fa-house nav-icon" aria-hidden="true"></i>
            <span>Home</span>
          </a>
          <a href="/prompt_manager/dashboard" class="nav-item">
            <i class="fa-solid fa-chart-line nav-icon" aria-hidden="true"></i>
            <span>Dashboard</span>
          </a>
          <a href="/prompt_manager/gallery" class="nav-item active">
            <i class="fa-solid fa-images nav-icon" aria-hidden="true"></i>
            <span>Gallery</span>
          </a>
          <a href="/prompt_manager/collections" class="nav-item">
            <i class="fa-solid fa-folder-tree nav-icon" aria-hidden="true"></i>
            <span>Collections</span>
          </a>
          <a href="/prompt_manager/stats" class="nav-item">
            <i class="fa-solid fa-chart-column nav-icon" aria-hidden="true"></i>
            <span>Stats</span>
          </a>
          <a href="/prompt_manager/metadata" class="nav-item">
            <i class="fa-solid fa-tags nav-icon" aria-hidden="true"></i>
            <span>Metadata</span>
          </a>
          <a href="/prompt_manager/settings" class="nav-item">
            <i class="fa-solid fa-gear nav-icon" aria-hidden="true"></i>
            <span>Settings</span>
          </a>
          <a href="/prompt_manager/logs" class="nav-item">
            <i class="fa-solid fa-clipboard-list nav-icon" aria-hidden="true"></i>
            <span>Logs</span>
          </a>
        </nav>

        <div class="sidebar-footer">
          <div class="progress progress-mb-sm">
            <div class="progress-bar progress-width-65"></div>
          </div>
          <div class="sidebar-header-subtitle">
            Images: 5,234 / 10,000
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Top Bar -->
        <header class="topbar">
          <div class="search-container">
            <input
              type="text"
              class="search-input"
              placeholder="Search images by prompt, model, or tags..."
              id="searchInput"
            />
            <span class="search-key-hint">/</span>
          </div>

          <div class="topbar-icon-buttons">
            <button class="action-btn action-btn-secondary" data-action="scan-images" title="Scan images">
              <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
              <span>Scan Images</span>
            </button>
            <button class="btn btn-primary" data-action="upload-image">
              <span><i class="fa-solid fa-upload" aria-hidden="true"></i></span>
              <span>Upload</span>
            </button>
          </div>
        </header>

        <!-- Content -->
        <div class="content-wrapper">
          <!-- Page Header -->
          <div class="page-header">
            <h1 class="page-title">Gallery</h1>
            <p class="page-subtitle">Browse and manage your generated images</p>
          </div>

          <!-- Toolbar -->
          <div class="toolbar">
            <div class="filter-bar">
              <select id="categoryFilterGallery" class="select">
                <option value="all">All Categories</option>
              </select>
              <select class="select">
                <option>All Models</option>
                <option>FLUX</option>
                <option>HiDream</option>
                <option>HunYuan</option>
                <option>Illustrious</option>
                <option>Pony</option>
                <option>Qwen</option>
                <option>Wan</option>
                <option>SD 1.5</option>
                <option>SDXL</option>
                <option>SD 3.5</option>
              </select>
              <select class="select">
                <option>All Time</option>
                <option>Today</option>
                <option>This Week</option>
                <option>This Month</option>
              </select>
              <select class="select">
                <option>Newest First</option>
                <option>Oldest First</option>
                <option>Most Liked</option>
              </select>
            </div>

            <div class="view-mode-toggle">
              <button class="view-mode-btn active" data-mode="grid" onclick="setViewMode('grid', event)">Grid</button>
              <button class="view-mode-btn" data-mode="masonry" onclick="setViewMode('masonry', event)">Masonry</button>
              <button class="view-mode-btn" data-mode="list" onclick="setViewMode('list', event)">List</button>
            </div>
          </div>

          <!-- Gallery Grid -->
          <div class="gallery-container gallery-grid" id="galleryContainer" data-view-mode="grid">
            <!-- Gallery items will be loaded dynamically by gallery-dynamic.js -->
          </div>

          <!-- Empty State (hidden by default) -->
          <div class="empty-state empty-state-hidden" id="emptyState">
            <div class="empty-icon"><i class="fa-solid fa-image" aria-hidden="true"></i></div>
            <h3>No images yet</h3>
            <p class="empty-text">
              Generate your first image or upload existing ones
            </p>
            <button class="btn btn-primary" data-action="upload-image">
              <span><i class="fa-solid fa-upload" aria-hidden="true"></i></span>
              <span>Upload Image</span>
            </button>
          </div>
        </div>
      </main>
    </div>

    <!-- Footer -->
    <footer class="main-footer">
      <div class="footer-content">
        <div class="footer-text">
          PromptManager — Clean, Fast, Local. © 2025
        </div>
        <div class="footer-links">
          <a href="#" class="footer-link">Documentation</a>
          <a href="#" class="footer-link">GitHub</a>
          <a href="#" class="footer-link">Support</a>
        </div>
      </div>
    </footer>

    <!-- External JavaScript files -->
    <!-- ViewerJS Library -->
    <script src="/prompt_manager/lib/viewerjs/dist/viewer.min.js"></script>

    <!-- ImagesLoaded Library - MUST be before gallery-dynamic.js -->
    <script src="/prompt_manager/lib/imagesloaded/imagesloaded.pkgd.min.js"></script>

    <!-- Core modules -->
    <script src="/prompt_manager/js/modules/core/events.js"></script>
    <script src="/prompt_manager/js/modules/core/websocket.js"></script>

    <!-- SSE Indicators -->
    <script src="/prompt_manager/js/modules/components/status-indicator.js"></script>
    <script src="/prompt_manager/js/modules/components/progress-indicator.js"></script>
    <script src="/prompt_manager/js/modules/components/footer-status.js"></script>

    <!-- ViewerJS Modules -->
    <script src="/prompt_manager/js/modules/components/viewer-manager.js"></script>
    <script src="/prompt_manager/js/modules/components/filmstrip-manager.js"></script>
    <script src="/prompt_manager/js/modules/services/metadata-manager.js"></script>
    <script src="/prompt_manager/js/modules/core/viewer-integration.js"></script>

    <!-- Scan Manager Module -->
    <script src="/prompt_manager/js/modules/components/scan-manager.js"></script>

    <!-- Scan Images Modal -->
    <!-- Existing scripts -->
    <script src="/prompt_manager/js/notifications.js"></script>
    <script src="/prompt_manager/js/gallery-page.js"></script>

    <!-- Dynamic Gallery Loader - Replaces mock data with real database content -->
    <script src="/prompt_manager/lib/masonry/masonry.pkgd.min.js"></script>
    <script src="/prompt_manager/js/modules/gallery/gallery-shared.js"></script>
    <script src="/prompt_manager/js/gallery-dynamic.js"></script>

    <!-- Initialize ViewerJS Integration -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Initialize EventBus if not already present
        if (!window.EventBus) {
          window.EventBus = {
            events: {},
            on(event, callback) {
              if (!this.events[event]) this.events[event] = [];
              this.events[event].push(callback);
            },
            emit(event, data) {
              if (!this.events[event]) return;
              this.events[event].forEach(cb => cb(data));
            },
            off(event, callback) {
              if (!this.events[event]) return;
              this.events[event] = this.events[event].filter(cb => cb !== callback);
            }
          };
        }

        // Initialize realtime status and progress indicators
        StatusIndicator.init({
          position: 'bottom-right',
          autoHide: true,
          autoHideDelay: 5000,
          showDetails: true
        });

        // Initialize Footer Status (compact footer version)
        FooterStatus.init({
          showText: true,
          showCount: true,
          enableTooltips: true
        });

        ProgressIndicator.init({
          position: 'top-center',
          showPercentage: true,
          showTimeEstimate: true,
          stackable: true
        });

        if (window.RealtimeUpdates) {
          RealtimeUpdates.init();
          RealtimeUpdates.subscribe('gallery:refresh', () => {
            if (window.refreshGallery) {
              window.refreshGallery();
            }
          });
        }

        // Initialize ViewerJS Integration with filmstrip size from settings
        try {
          const settings = JSON.parse(localStorage.getItem('promptManagerSettings') || '{}');
          const filmstripSize = settings.filmstripSize || 'medium';

          // Map settings to thumbnail heights
          const sizeMap = {
            'small': 60,
            'medium': 80,
            'large': 100
          };

          ViewerIntegration.init({
            viewer: {
              theme: 'dark',
              fullscreen: true,
              keyboard: true
            },
            filmstrip: {
              enabled: true,
              position: 'bottom',
              autoHide: false,
              lazyLoad: true,
              thumbnailHeight: sizeMap[filmstripSize] || 80
            },
            metadata: {
              enabled: true,
              position: 'right',
              autoShow: true
            }
          });
        } catch (e) {
          console.warn('Failed to load filmstrip size setting, using defaults:', e);
          // Fallback to default initialization
          ViewerIntegration.init({
            viewer: {
              theme: 'dark',
              fullscreen: true,
              keyboard: true
            },
            filmstrip: {
              enabled: true,
              position: 'bottom',
              autoHide: false,
              lazyLoad: true,
              thumbnailHeight: 80
            },
            metadata: {
              enabled: true,
              position: 'right',
              autoShow: true
            }
          });
        }

        // Initialize Scan Manager
        ScanManager.init({
          apiEndpoint: '/api/scan'
        });
      });
    </script>
  </body>
</html>
