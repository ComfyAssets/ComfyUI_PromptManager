<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>PromptManager â€” Metadata Extractor</title>
    <link rel="stylesheet" href="/prompt_manager/css/style.css" />
    <link rel="stylesheet" href="/prompt_manager/css/blue-theme-update.css" />
    <link rel="stylesheet" href="/prompt_manager/css/components.css" />
    <link rel="stylesheet" href="/prompt_manager/css/metadata.css" />
    <link rel="stylesheet" href="/prompt_manager/css/notifications.css" />
    <link rel="stylesheet" href="/prompt_manager/css/migration.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- ViewerJS CSS -->
    <link rel="stylesheet" href="/prompt_manager/vendor/viewerjs/dist/viewer.min.css" />

</head>
  <body x-data="pmMetaApp()" x-init="init()">
    <div class="app-container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <div id="brand-badge" class="brand-badge">PM</div>
          <div>
            <div class="sidebar-header-title">PromptManager</div>
            <div class="sidebar-header-subtitle">
              Professional Suite
            </div>
          </div>
        </div>

                                                <nav class="nav-menu">
          <a href="/prompt_manager/" class="nav-item">
            <i class="fa-solid fa-house nav-icon" aria-hidden="true"></i>
            <span>Home</span>
          </a>
          <a href="/prompt_manager/dashboard" class="nav-item">
            <i class="fa-solid fa-chart-line nav-icon" aria-hidden="true"></i>
            <span>Dashboard</span>
          </a>
          <a href="/prompt_manager/gallery" class="nav-item">
            <i class="fa-solid fa-images nav-icon" aria-hidden="true"></i>
            <span>Gallery</span>
          </a>
          <a href="/prompt_manager/collections" class="nav-item">
            <i class="fa-solid fa-folder-tree nav-icon" aria-hidden="true"></i>
            <span>Collections</span>
          </a>
          <a href="/prompt_manager/stats" class="nav-item">
            <i class="fa-solid fa-chart-column nav-icon" aria-hidden="true"></i>
            <span>Stats</span>
          </a>
          <a href="/prompt_manager/metadata" class="nav-item active">
            <i class="fa-solid fa-tags nav-icon" aria-hidden="true"></i>
            <span>Metadata</span>
          </a>
          <a href="/prompt_manager/settings" class="nav-item">
            <i class="fa-solid fa-gear nav-icon" aria-hidden="true"></i>
            <span>Settings</span>
          </a>
          <a href="/prompt_manager/logs" class="nav-item">
            <i class="fa-solid fa-clipboard-list nav-icon" aria-hidden="true"></i>
            <span>Logs</span>
          </a>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Topbar -->
        <div class="topbar">
          <div class="search-container">
            <input
              type="text"
              placeholder="Search metadata..."
              class="search-input"
            />
          </div>
          <div class="topbar-actions">
            <button class="btn btn-ghost">
              <span><i class="fa-regular fa-bell" aria-hidden="true"></i></span>
            </button>
            <button class="btn btn-ghost">
              <span><i class="fa-solid fa-gear" aria-hidden="true"></i></span>
            </button>
          </div>
        </div>

        <!-- Page Content -->
        <div class="page-content">
          <div class="page-header">
            <div>
              <h1>Metadata Extractor</h1>
              <p>Extract ComfyUI workflow data from PNG images</p>
            </div>
          </div>

          <!-- Drop Zone -->
          <section :class="['drop-zone', drag ? 'drag' : '', thumb ? 'small' : 'large']" @dragover.prevent="drag=true" @dragleave="drag=false" @drop.prevent="handleDrop($event)">
            <div class="drop-zone-content">
              <div class="drop-zone-icon">ðŸ“Ž</div>
              <div class="drop-zone-text">
                Drag & drop image (PNG/JPEG/WEBP) or
              </div>
              <input id="pick" type="file" accept="image/*" class="file-input-hidden" @change="filePicked" />
              <button class="btn btn-primary" @click="document.getElementById('pick').click()">
                Choose File
              </button>
            </div>
          </section>
          <div x-show="error" class="metadata-error" x-text="error" role="alert"></div>

          <!-- Image and Prompts -->
          <template x-if="thumb">
            <div class="metadata-grid">
              <div class="card">
                <h3 class="card-title">Image Preview</h3>
                <img class="preview" :src="thumb" alt="preview" />
                <div class="file-info">
                  <span x-text="fileName"></span> â€¢
                  <span x-text="fileType"></span> â€¢
                  <span x-text="(fileSize/1024).toFixed(1) + ' KB'"></span>
                </div>
              </div>

              <div class="card">
                <div class="section-header">
                  <h3 class="section-title">Extracted Prompts</h3>
                  <div class="btn-actions">
                    <button class="btn btn-secondary btn-sm" @click="copy(texts.positive)">
                      Copy Positive
                    </button>
                    <button class="btn btn-secondary btn-sm" @click="copy(texts.negative)">
                      Copy Negative
                    </button>
                  </div>
                </div>

                <div class="prompt-section">
                  <div class="prompt-indicator">
                    <div class="indicator-dot-brand"></div>
                    <strong>Positive Prompt</strong>
                  </div>
                  <pre x-text="texts.positive || '(none found)'"></pre>
                </div>

                <div>
                  <div class="prompt-indicator">
                    <div class="indicator-dot-pink"></div>
                    <strong>Negative Prompt</strong>
                  </div>
                  <pre x-text="texts.negative || '(none found or not used by this model)'"></pre>
                </div>
              </div>

              <div class="card metadata-summary-card" x-show="summaryRows().length">
                <div class="section-header">
                  <h3 class="section-title">Generation Metadata</h3>
                  <button class="btn btn-secondary btn-sm" @click="copySummary()">
                    Copy All
                  </button>
                </div>
                <div class="summary-grid">
                  <template x-for="item in summaryRows()" :key="item.label">
                    <div class="summary-row">
                      <span class="summary-label" x-text="item.label"></span>
                      <span class="summary-value" x-text="item.value"></span>
                    </div>
                  </template>
                </div>
              </div>
            </div>
          </template>

          <!-- Workflow and Raw Data -->
          <template x-if="workflow || raw">
            <div class="metadata-grid">
              <div class="card">
                <div class="section-header">
                  <h3 class="section-title">Workflow Data</h3>
                  <button class="btn btn-secondary btn-sm" @click="copy(workflow)">
                    Copy JSON
                  </button>
                </div>
                <pre x-text="workflow || '(none found)'"></pre>
              </div>

              <div class="card">
                <div class="section-header">
                  <h3 class="section-title">Raw Metadata</h3>
                  <button class="btn btn-secondary btn-sm" @click="downloadRaw">
                    Download JSON
                  </button>
                </div>
                <pre x-text="raw"></pre>
              </div>
            </div>
          </template>

          <!-- Empty State -->
          <div x-show="!thumb && !workflow && !raw" class="empty-state-metadata">
            <div class="empty-state-icon-large"><i class="fa-solid fa-tags" aria-hidden="true"></i></div>
            <h3 class="empty-state-title">No Image Selected</h3>
            <p class="empty-state-text">Upload an image to extract its metadata and workflow information</p>
          </div>
        </div>
      </main>
    </div>
    <script>
      (function () {
        const SUMMARY_FIELDS = [
          { key: 'model', label: 'Model' },
          { key: 'loras', label: 'Lora(s)' },
          { key: 'cfgScale', label: 'cfgScale' },
          { key: 'steps', label: 'steps' },
          { key: 'sampler', label: 'sampler' },
          { key: 'seed', label: 'seed' },
          { key: 'clipSkip', label: 'clipSkip' },
          { key: 'workflow', label: 'Workflow' }
        ];

        function safeStringify(value) {
          if (value === undefined || value === null) {
            return '';
          }
          try {
            return JSON.stringify(value, null, 2);
          } catch (error) {
            console.warn('Failed to stringify metadata', error);
            return String(value);
          }
        }

        function normalizeSummaryValue(value) {
          if (value === undefined || value === null) return 'None';

          if (typeof value === 'string') {
            const trimmed = value.trim();
            return trimmed ? trimmed : 'None';
          }

          if (typeof value === 'number' || typeof value === 'boolean') {
            return String(value);
          }

          if (Array.isArray(value)) {
            const parts = value
              .map((item) => normalizeSummaryValue(item))
              .filter((item) => item && item !== 'None');
            return parts.length ? parts.join(', ') : 'None';
          }

          if (typeof value === 'object') {
            if (value.name) {
              const strengths = [];
              if (value.strength !== undefined && value.strength !== null) {
                strengths.push(`strength ${value.strength}`);
              }
              if (value.strength_model !== undefined && value.strength_model !== null) {
                strengths.push(`model ${value.strength_model}`);
              }
              if (value.strength_clip !== undefined && value.strength_clip !== null) {
                strengths.push(`clip ${value.strength_clip}`);
              }
              return strengths.length ? `${value.name} (${strengths.join(', ')})` : value.name;
            }

            if (value.text) {
              return normalizeSummaryValue(value.text);
            }

            return 'Embedded data';
          }

          return 'None';
        }

        function countWorkflowNodes(workflow) {
          if (!workflow || typeof workflow !== 'object') {
            return 0;
          }

          if (Array.isArray(workflow)) {
            return workflow.length;
          }

          if (workflow.nodes) {
            const nodes = workflow.nodes;
            if (Array.isArray(nodes)) {
              return nodes.length;
            }
            if (nodes && typeof nodes === 'object') {
              return Object.keys(nodes).length;
            }
          }

          try {
            return Object.keys(workflow).length;
          } catch {
            return 0;
          }
        }

        function formatWorkflow(workflow) {
          if (!workflow) return '';
          if (typeof workflow === 'string') {
            const trimmed = workflow.trim();
            if (!trimmed) return '';
            try {
              return JSON.stringify(JSON.parse(trimmed), null, 2);
            } catch {
              return trimmed;
            }
          }

          return JSON.stringify(workflow, null, 2);
        }

        function formatWorkflowSummary(workflow) {
          if (!workflow) return 'Not embedded';
          const parsed = typeof workflow === 'string'
            ? (() => {
                try {
                  return JSON.parse(workflow);
                } catch {
                  return workflow;
                }
              })()
            : workflow;

          if (typeof parsed === 'string') {
            const trimmed = parsed.trim();
            return trimmed || 'Embedded workflow';
          }

          const nodeCount = countWorkflowNodes(parsed);
          return nodeCount > 0 ? `Embedded workflow (${nodeCount} nodes)` : 'Embedded workflow';
        }

        function pick(...candidates) {
          for (const candidate of candidates) {
            if (candidate !== undefined && candidate !== null && candidate !== '') {
              return candidate;
            }
          }
          return null;
        }

        function textValue(candidate) {
          if (candidate === undefined || candidate === null) {
            return '';
          }
          if (typeof candidate === 'string') {
            return candidate;
          }
          if (typeof candidate === 'number' || typeof candidate === 'boolean') {
            return String(candidate);
          }
          return '';
        }

        function buildSummary(metadata) {
          if (!metadata || typeof metadata !== 'object') return null;

          const comfy = metadata.comfy_parsed && typeof metadata.comfy_parsed === 'object' ? metadata.comfy_parsed : {};

          const positivePrompt = pick(metadata.positive_prompt, comfy.positive_prompt);
          const negativePrompt = pick(metadata.negative_prompt, comfy.negative_prompt);
          const model = pick(metadata.model, comfy.model);
          const loras = pick(metadata.loras, comfy.loras);
          const cfgScale = pick(metadata.cfg_scale, comfy.cfg_scale);
          const steps = pick(metadata.steps, comfy.steps);
          const sampler = pick(metadata.sampler, comfy.sampler);
          const seed = pick(metadata.seed, comfy.seed);
          const clipSkip = pick(metadata.clip_skip, comfy.clip_skip);
          const workflow = pick(metadata.workflow, comfy.workflow);

          return {
            positivePrompt: normalizeSummaryValue(positivePrompt),
            negativePrompt: normalizeSummaryValue(negativePrompt),
            model: normalizeSummaryValue(model),
            loras: normalizeSummaryValue(loras),
            cfgScale: normalizeSummaryValue(cfgScale),
            steps: normalizeSummaryValue(steps),
            sampler: normalizeSummaryValue(sampler),
            seed: normalizeSummaryValue(seed),
            clipSkip: normalizeSummaryValue(clipSkip),
            workflow: formatWorkflowSummary(workflow)
          };
        }

        async function requestMetadataFromApi(file) {
          const endpointCandidates = [
            '/api/v1/metadata/extract',
            '/prompt_manager/api/v1/metadata/extract',
            '/api/prompt_manager/api/v1/metadata/extract'
          ];

          let lastError = null;

          for (const endpoint of endpointCandidates) {
            const formData = new FormData();
            formData.append('file', file);

            try {
              console.debug('[PromptManager] metadata upload ->', endpoint);
              const response = await fetch(endpoint, {
                method: 'POST',
                body: formData
              });

              let payload = {};
              let rawText = '';
              try {
                rawText = await response.text();
              } catch (textError) {
                console.warn('[PromptManager] metadata upload text read failed <-', endpoint, textError);
              }

              if (rawText) {
                try {
                  payload = JSON.parse(rawText);
                } catch (parseError) {
                  console.warn('[PromptManager] metadata upload JSON parse failed <-', endpoint, parseError, rawText.slice(0, 200));
                  payload = {};
                }
              }

              if (response.ok && payload?.success) {
                console.debug('[PromptManager] metadata upload success <-', endpoint, payload);
                return payload.data || {};
              }

              const message = payload?.error || payload?.message || (rawText ? rawText.slice(0, 120) : '') || response.statusText || `Request failed (${response.status})`;
              console.warn('[PromptManager] metadata upload failed <-', endpoint, message);
              lastError = new Error(message);
            } catch (error) {
              console.warn('[PromptManager] metadata upload exception <-', endpoint, error);
              lastError = error;
            }
          }

          throw lastError || new Error('Metadata extraction failed');
        }

        window.pmMetaApp = function () {
          return {
            drag: false,
            thumb: '',
            fileName: '',
            fileSize: 0,
            fileType: '',
            metadata: null,
            texts: { positive: '', negative: '' },
            workflow: '',
            raw: '',
            summary: null,
            error: null,
            init() {
              this.error = null;
            },
            async handleDrop(event) {
              this.drag = false;
              const file = event.dataTransfer.files?.[0];
              if (file) {
                await this.processFile(file);
              }
            },
            async filePicked(event) {
              const file = event.target.files?.[0];
              if (file) {
                await this.processFile(file);
                event.target.value = '';
              }
            },
            async processFile(file) {
              this.error = null;
              this.metadata = null;
              this.texts = { positive: '', negative: '' };
              this.workflow = '';
              this.raw = '';
              this.summary = null;

              if (this.thumb) {
                URL.revokeObjectURL(this.thumb);
              }
              this.thumb = URL.createObjectURL(file);

              this.fileName = file.name;
              this.fileSize = file.size;
              this.fileType = file.type || '';

              try {
                const metadata = await requestMetadataFromApi(file);
                this.applyMetadata(metadata);
              } catch (error) {
                console.error('Metadata extraction failed', error);
                this.error = error?.message || 'Metadata extraction failed';
              }
            },
            applyMetadata(metadata) {
              console.debug('[PromptManager] metadata payload', metadata);
              this.metadata = metadata;

              if (metadata.file_size && !Number.isNaN(Number(metadata.file_size))) {
                this.fileSize = Number(metadata.file_size);
              }
              if (metadata.mime_type || metadata.format) {
                this.fileType = metadata.mime_type || metadata.format;
              }

              const comfy = metadata.comfy_parsed && typeof metadata.comfy_parsed === 'object' ? metadata.comfy_parsed : {};
              const positiveRaw = textValue(pick(metadata.positive_prompt, comfy.positive_prompt));
              const negativeRaw = textValue(pick(metadata.negative_prompt, comfy.negative_prompt));
              this.texts = {
                positive: positiveRaw,
                negative: negativeRaw
              };

              const workflowSource = pick(metadata.workflow, comfy.workflow);
              this.workflow = formatWorkflow(workflowSource);

              this.summary = buildSummary(metadata);
              this.raw = safeStringify(metadata);
            },
            copy(text) {
              const value = text || '';
              if (!value) return;
              if (navigator.clipboard) {
                navigator.clipboard.writeText(value).catch((error) => console.warn('Clipboard copy failed', error));
              }
              if (window.showToast) {
                window.showToast('Copied!', 'success');
              }
            },
            copySummary() {
              const rows = this.summaryRows();
              if (!rows.length) return;
              const payload = rows.map((row) => `${row.label}: ${row.value}`).join('\n');
              this.copy(payload);
            },
            summaryRows() {
              if (!this.summary) {
                return [];
              }
              return SUMMARY_FIELDS.map(({ key, label }) => ({
                label,
                value: this.summary[key] ?? 'None'
              }));
            },
            downloadRaw() {
              const payload = safeStringify(this.metadata || {});
              const blob = new Blob([payload || '{}'], { type: 'application/json' });
              const url = URL.createObjectURL(blob);
              const anchor = document.createElement('a');
              anchor.href = url;
              anchor.download = 'metadata.json';
              anchor.click();
              URL.revokeObjectURL(url);
            }
          };
        };
      })();
    </script>


    <!-- ViewerJS Library -->
    <script src="/prompt_manager/vendor/viewerjs/dist/viewer.min.js"></script>

    <!-- Core modules -->
    <script src="/prompt_manager/js/modules/core/events.js"></script>
    <script src="/prompt_manager/js/modules/core/sse.js"></script>

    <!-- SSE Indicators -->
    <script src="/prompt_manager/js/modules/components/status-indicator.js"></script>
    <script src="/prompt_manager/js/modules/components/progress-indicator.js"></script>
    <script src="/prompt_manager/js/modules/components/footer-status.js"></script>

    <!-- ViewerJS Modules -->
    <script src="/prompt_manager/js/modules/components/viewer-manager.js"></script>
    <script src="/prompt_manager/js/modules/components/filmstrip-manager.js"></script>
    <script src="/prompt_manager/js/modules/services/metadata-manager.js"></script>

        <script src="/prompt_manager/js/modules/core/viewer-integration.js"></script>

        <!-- Existing scripts -->
        <script src="/prompt_manager/js/notifications.js"></script>

<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Footer -->
    <footer class="main-footer">
      <div class="footer-content">
        <div class="footer-text">
          PromptManager â€” Clean, Fast, Local. Â© 2025
        </div>
        <div class="footer-links">
          <a href="#" class="footer-link">Documentation</a>
          <a href="#" class="footer-link">GitHub</a>
          <a href="#" class="footer-link">Support</a>
        </div>
      </div>
    </footer>
  </body>
  </html>
