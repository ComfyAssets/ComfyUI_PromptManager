<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Gallery - Prompt Manager</title>

    <!-- ViewerJS CSS -->
    <link rel="stylesheet" href="vendor/viewerjs/viewer.css">

    <!-- Gallery Styles -->
    <link rel="stylesheet" href="css/gallery.css">
    <link rel="stylesheet" href="css/viewer-integration.css">
    <link rel="stylesheet" href="css/metadata.css">

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* Unified Gallery Specific Styles */
        .unified-gallery-container {
            display: flex;
            height: 100vh;
            background: var(--bg-primary, #1a1a1a);
            color: var(--text-primary, #e0e0e0);
        }

        .gallery-sidebar {
            width: 300px;
            background: var(--bg-secondary, #2a2a2a);
            border-right: 1px solid var(--border-color, #3a3a3a);
            display: flex;
            flex-direction: column;
            transition: margin-left 0.3s;
        }

        .gallery-sidebar.collapsed {
            margin-left: -300px;
        }

        .gallery-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .gallery-header {
            padding: 1rem;
            background: var(--bg-secondary, #2a2a2a);
            border-bottom: 1px solid var(--border-color, #3a3a3a);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .gallery-toolbar {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .gallery-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .gallery-filters {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color, #3a3a3a);
        }

        .filter-group {
            margin-bottom: 1rem;
        }

        .filter-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 0.5rem;
            background: var(--bg-primary, #1a1a1a);
            border: 1px solid var(--border-color, #3a3a3a);
            color: var(--text-primary, #e0e0e0);
            border-radius: 4px;
        }

        .gallery-settings-toggle {
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .gallery-settings-toggle:hover {
            background: var(--bg-hover, #3a3a3a);
        }

        .view-mode-selector {
            display: flex;
            gap: 0.5rem;
        }

        .view-mode-btn {
            padding: 0.5rem 0.75rem;
            background: transparent;
            border: 1px solid var(--border-color, #3a3a3a);
            color: var(--text-primary, #e0e0e0);
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-mode-btn.active {
            background: var(--accent, #007bff);
            border-color: var(--accent, #007bff);
        }

        .view-mode-btn:hover:not(.active) {
            background: var(--bg-hover, #3a3a3a);
        }

        /* Gallery Grid Variations */
        .gallery-grid {
            display: grid;
            gap: 1rem;
        }

        .gallery-grid.gallery-grid {
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        }

        .gallery-grid.gallery-list {
            grid-template-columns: 1fr;
        }

        .gallery-grid.gallery-masonry {
            column-count: 4;
            column-gap: 1rem;
        }

        @media (max-width: 1200px) {
            .gallery-grid.gallery-masonry {
                column-count: 3;
            }
        }

        @media (max-width: 768px) {
            .gallery-sidebar {
                position: absolute;
                z-index: 100;
                height: 100%;
            }

            .gallery-grid.gallery-masonry {
                column-count: 2;
            }
        }

        /* Loading and Error States */
        .gallery-loader {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary, #999);
        }

        .gallery-error {
            text-align: center;
            padding: 2rem;
            color: var(--error, #ff5555);
        }

        /* Selection Counter */
        .selection-counter {
            padding: 0.75rem;
            background: var(--accent, #007bff);
            color: white;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <div class="unified-gallery-container">
        <!-- Sidebar with Filters -->
        <aside class="gallery-sidebar" id="gallerySidebar">
            <div class="gallery-filters">
                <h3>Filters</h3>

                <div class="filter-group">
                    <label for="searchFilter">Search</label>
                    <input type="text" id="searchFilter" placeholder="Search prompts...">
                </div>

                <div class="filter-group">
                    <label for="tagFilter">Tags</label>
                    <input type="text" id="tagFilter" placeholder="Enter tags...">
                </div>

                <div class="filter-group">
                    <label for="dateFromFilter">From Date</label>
                    <input type="date" id="dateFromFilter">
                </div>

                <div class="filter-group">
                    <label for="dateToFilter">To Date</label>
                    <input type="date" id="dateToFilter">
                </div>

                <div class="filter-group">
                    <label for="modelFilter">Model</label>
                    <select id="modelFilter">
                        <option value="">All Models</option>
                    </select>
                </div>

                <button class="btn btn-primary" id="applyFilters">Apply Filters</button>
                <button class="btn btn-secondary" id="clearFilters">Clear</button>
            </div>

            <!-- Settings Panel -->
            <div id="gallery-settings-panel" style="flex: 1; overflow-y: auto; padding: 1rem;">
                <!-- Settings will be populated by gallery-settings-connector.js -->
            </div>
        </aside>

        <!-- Main Gallery Area -->
        <main class="gallery-main">
            <!-- Header with Toolbar -->
            <header class="gallery-header">
                <div class="gallery-toolbar">
                    <button id="toggleSidebar" class="btn btn-icon" title="Toggle Sidebar">
                        <i class="fas fa-bars"></i>
                    </button>

                    <div class="view-mode-selector">
                        <button class="view-mode-btn active" data-mode="grid" title="Grid View">
                            <i class="fas fa-th"></i>
                        </button>
                        <button class="view-mode-btn" data-mode="list" title="List View">
                            <i class="fas fa-list"></i>
                        </button>
                        <button class="view-mode-btn" data-mode="masonry" title="Masonry View">
                            <i class="fas fa-layer-group"></i>
                        </button>
                    </div>

                    <button id="refreshGallery" class="btn btn-icon" title="Refresh">
                        <i class="fas fa-sync"></i>
                    </button>

                    <button id="exportSelection" class="btn btn-icon" title="Export Selected">
                        <i class="fas fa-download"></i>
                    </button>
                </div>

                <div class="gallery-settings-toggle" title="Settings">
                    <i class="fas fa-cog"></i>
                </div>
            </header>

            <!-- Gallery Content Area -->
            <div class="gallery-content" id="galleryContent">
                <!-- Gallery items will be rendered here -->
                <div class="gallery-loader">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p>Loading gallery...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- ViewerJS -->
    <script src="vendor/viewerjs/viewer.js"></script>

    <!-- Core Modules -->
    <script src="js/modules/core/viewer-integration.js"></script>
    <script src="js/modules/core/viewer-manager.js"></script>
    <script src="js/modules/core/filmstrip-manager.js"></script>
    <script src="js/modules/core/metadata-manager.js"></script>

    <!-- Gallery Modules -->
    <script src="js/modules/gallery/unified-gallery.js"></script>
    <script src="js/modules/settings/gallery-settings-connector.js"></script>

    <!-- Initialize Gallery -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the unified gallery
            const galleryInstance = UnifiedGallery.init(
                document.getElementById('galleryContent'),
                {
                    itemsPerPage: 20,
                    viewMode: 'grid',
                    sortOrder: 'date_desc'
                }
            );

            // Setup sidebar toggle
            document.getElementById('toggleSidebar').addEventListener('click', function() {
                document.getElementById('gallerySidebar').classList.toggle('collapsed');
            });

            // Setup view mode buttons
            document.querySelectorAll('.view-mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.view-mode-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    galleryInstance.setViewMode(this.dataset.mode);
                });
            });

            // Setup refresh button
            document.getElementById('refreshGallery').addEventListener('click', function() {
                galleryInstance.refresh();
            });

            // Setup export button
            document.getElementById('exportSelection').addEventListener('click', function() {
                galleryInstance.exportSelection();
            });

            // Setup filter application
            document.getElementById('applyFilters').addEventListener('click', function() {
                const filter = {
                    search: document.getElementById('searchFilter').value,
                    tags: document.getElementById('tagFilter').value.split(',').filter(t => t.trim()),
                    dateFrom: document.getElementById('dateFromFilter').value,
                    dateTo: document.getElementById('dateToFilter').value,
                    model: document.getElementById('modelFilter').value
                };
                galleryInstance.setFilter(filter);
            });

            // Setup filter clear
            document.getElementById('clearFilters').addEventListener('click', function() {
                document.getElementById('searchFilter').value = '';
                document.getElementById('tagFilter').value = '';
                document.getElementById('dateFromFilter').value = '';
                document.getElementById('dateToFilter').value = '';
                document.getElementById('modelFilter').value = '';
                galleryInstance.setFilter(null);
            });

            // Setup settings toggle
            document.querySelector('.gallery-settings-toggle').addEventListener('click', function() {
                const panel = document.getElementById('gallery-settings-panel');
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            });

            // Listen for settings changes
            GallerySettingsConnector.subscribe(function(event) {
                if (event.type === 'update' || event.type === 'reset') {
                    // Settings have changed, gallery will auto-update via event listeners
                    console.log('Gallery settings updated:', event.data);
                }
            });

            // Load available models for filter
            fetch('/api/promptmanager/models')
                .then(res => res.json())
                .then(models => {
                    const select = document.getElementById('modelFilter');
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.name;
                        option.textContent = model.display_name || model.name;
                        select.appendChild(option);
                    });
                })
                .catch(err => console.warn('Failed to load models:', err));
        });
    </script>
</body>
</html>